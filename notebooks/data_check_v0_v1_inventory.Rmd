---
title: "Data Check v0 and v1: Inventory"
author: "Virgilio Gonzenbach"
date: "2/16/2023"
output: 
    html_document:
      self_contained: false
      theme: cosmo
      toc: true
      toc_depth: 2
      toc_float: true
      df_print: paged
      code_folding: hide
      highlight: textmate
      fig_caption: true
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "../docs"
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r library, message=FALSE}
library(dplyr)
library(stringr)
library(purrr)
library(here)
```

# Inventory of MSCAMRAS dwi data

This notebook reviews the state of the raw data located `/home/vgonzenb/mscamras/data/v0`.
The `v0` directory contains raw data that was organized into BIDS format without modifications to
either the data or metadata. 
  
If canonical BIDS format had been followed the relative path for a T1-weighted image
would look like `data/v0/sub-<subject-id>/ses-<site-id>/anat/sub-<subject-id>_ses-<site-id>_run-<visit-id>_T1w.nii.gz`.
Since qsiprep merges T1s across sessions and runs (which we want to avoid since data should be independent across sites), 
the data was organized so that each subject, site, and visit combination would be 
its own (modified) subject id like so: `data/v0/sub-<subject-id><site-id><visit-id>/anat/sub-<subject-id><site-id><visit-id>_T1w.nii.gz`.

Additionally, the keyword `acq` indicates whether a scan was collected with distortion correction (taking values `D`) or without it (`ND`). 
Data from Hopkins was collected with distortion correction turned on, while all other sites acquired data both with and without distortion correction. 
The copy of the data used in this project excludes the distortion corrected data for Penn, NIH and BWH. [TODO: double check]

Below, we inventory the T1w and dwi data.

## T1w

```{r}
t1_paths <- Sys.glob(here::here("data/v0/sub-*/anat/*T1w.nii.gz")) # search bids
t1_df <- data.frame(t1_path = t1_paths)
# Parse paths
t1_df <- t1_df %>% 
  mutate(subject = str_extract(t1_path, "(?<=sub-)\\d{5}"),
         site = str_extract(t1_path, "(?<=sub-\\d{5})\\D+"),
         visit = str_extract(t1_path, "\\d+(?=_acq)"), 
         .before = t1_path)
```

If a subject completed all their appointments,they should have had 2 visits at each of the 4 sites. Therefore, every subject should (ideally) have 8 T1-weighted images. The number of T1s for each subject is given in the following table:

```{r}
# Count images per subject
(n_images <- t1_df %>% 
  count(subject))
# Get subjects with less than 8 images
subjects_with_lt_8_imgs <- n_images |> 
  filter(n < 8) |> 
  pull(subject)
```

Subjects `r knitr::combine_words(subjects_with_lt_8_imgs)` have less than 8 images. We take a look at these subjects in more detail.

```{r}
# Get list of dataframe for each individual subject missing  at least one image
missing_imgs_per_subject <- t1_df %>% 
  filter(subject %in% subjects_with_lt_8_imgs) %>% 
  split(.$subject) %>% 
  setNames(subjects_with_lt_8_imgs)
```

Subject 03001 appears to be missing scans from NIH and Hopkins. [TODO: check in source data] [TODO: if really missing; document with Abby or Luyun the reason]

```{r}
missing_imgs_per_subject[['03001']]
```

Subject 03002 appears to be missing scans from Penn. [TODO: check in source data] [TODO: if really missing document with Abby or Luyun the reason]

```{r}
missing_imgs_per_subject[['03002']]
```

## DWI

During DWI acquisition, 2 opposite phase-encoding directions were collected to correct using FSL TOPUP. Therefore, it is expected that each subject should have 16 images (if all visits were completed). 

The phase-encoding direction for an image. This is also (which we examine below)

```{r}
# get dwi paths into data.frame
dwi_paths <- Sys.glob(here::here("data/v0/sub-*/dwi/*.nii.gz"))
dwi_df <- data.frame(dwi_path = dwi_paths) #

# parse subject, site and visit each paths
dwi_df <- dwi_df %>% 
  mutate(subject = str_extract(dwi_path, "(?<=sub-)\\d{5}"),
         site = str_extract(dwi_path, "(?<=sub-\\d{5})\\D+"),
         visit = str_extract(dwi_path, "\\d+(?=_acq)"), 
         .before = dwi_path)
```


```{r}
# Count images per subject
(n_images <- dwi_df %>% 
  count(subject))
# Get subjects with less than 8 images
subjects_missing_imgs <- n_images |> 
  filter(n < 16) |> 
  pull(subject)
```

Subjects `r knitr::combine_words(subjects_missing_imgs)` have less than 16 images. We take a look at these subjects in more detail.

```{r}
# Get list of dataframe for each individual subject missing  at least one image
subjects_missing_imgs_df <- dwi_df %>%
  filter(subject %in% subjects_missing_imgs) 

missing_imgs_per_subject <- subjects_missing_imgs_df |> 
split(subjects_missing_imgs_df$subject) |>
  setNames(subjects_missing_imgs)
```

Subject 02001 appears to be missing images from NIH. [TODO: check why]

```{r}
missing_imgs_per_subject[['02001']]
```

Subject 03001 appears to be missing images from NIH and Hopkins. [TODO: check why]

```{r}
missing_imgs_per_subject[['03001']]
```

Subject 03002 appears to be missing images from Penn [TODO: check why]

```{r}
missing_imgs_per_subject[['03002']]
```

# Conclusion

Subjects (i.e. subject-site-visit combination) with missing DTIs are excluded from v1 and subsequent data versions.
