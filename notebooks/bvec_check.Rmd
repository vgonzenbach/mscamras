---
title: "DTI MSCAMRAS: QSIPREP run troubleshooting"
author: "Virgilio Gonzenbach"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    code_folding: hide
    toc_float: true
    theme: spacelab
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Outputs

```{r, results='asis'}
qsiprep_run_report = system("bash tmp/check_qsiprep_output.sh", intern=TRUE)
for (line in qsiprep_run_report){
  cat(line, "\n")
}
```


## Error

The following errors were thrown when running qsiprep by subject:

```{r, echo=TRUE, eval=FALSE}
sub-03002NIH02  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-02003NIH02  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-04003NIH02  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-01002NIH01  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-01001NIH01  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-01001Penn02 Exception: Bvecs do not match - ensure matching bvecs
sub-04002Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-04003BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-04001NIH02  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-02003NIH01  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-02001Penn02 Exception: Bvecs do not match - ensure matching bvecs
sub-02002BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-04003BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-04001BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-01003Penn02 Exception: Bvecs do not match - ensure matching bvecs
sub-01002BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-04002Penn02 Exception: Bvecs do not match - ensure matching bvecs
sub-01003BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-02001Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-01002Penn02 Exception: Bvecs do not match - ensure matching bvecs
sub-01002BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-03002BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-02003Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-04001Penn02 Exception: Bvecs do not match - ensure matching bvecs
sub-03001BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-04003Penn02 Exception: Bvecs do not match - ensure matching bvecs
sub-02001BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-03002BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-02003BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-01003NIH02  Exception: Bvecs do not match - ensure matching bvecs
sub-04003NIH01  Exception: Bvecs do not match - ensure matching bvecs
sub-03001BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-04001BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-01001BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-04002BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-01002NIH02  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-01003BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-01001Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-02002NIH01  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-02003BWH02  Exception: Bvecs do not match - ensure matching bvecs
sub-01001NIH02  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-04001Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-02002NIH02  Exception: Bvecs do not match - ensure matching bvecs
sub-03001Penn02 Exception: Bvecs do not match - ensure matching bvecs
sub-01001BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-03001Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-02002BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-04003Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-02001BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-04001NIH01  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-03002NIH01  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-04002NIH01  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-04002NIH02  Exception: Unable to merge using strategy 'average': exactly two distortion groups must be present in data. Found 1
sub-02003Penn02 Exception: Bvecs do not match - ensure matching bvecs
sub-01003Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-04002BWH01  Exception: Bvecs do not match - ensure matching bvecs
sub-02002Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-01002Penn01 Exception: Bvecs do not match - ensure matching bvecs
sub-02002Penn02 Exception: Bvecs do not match - ensure matching bvecs
```

Thus, we check the bvec (and bvals) for the subjects that are having an error: `Exception: Bvecs do not match - ensure matching bvecs`.

## Bval and Bvec checks

```{r, message=FALSE}
library(dplyr)
library(stringr)
library(purrr)

# get bvec and bval paths
bvec_filepaths <- Sys.glob(here::here("data/sub-*/dwi/*.bvec"))
bval_filepaths <- Sys.glob(here::here("data/sub-*/dwi/*.bval"))

# check that they are the same except for extension. then make data.frame
if ( all(tools::file_path_sans_ext(bvec_filepaths) == tools::file_path_sans_ext(bval_filepaths))){
  bvec_df <- data.frame(bvec_path = bvec_filepaths,
                      bval_path = bval_filepaths)
}

#' Read bvecs or bvals from file
#' @param path the path to a bvec or bval file
#' @return a vector of numeric values (a flattened matrix)
read_matrix <- function(path){
  path |>
    read.table() |>
    as.matrix() 
}

# parse subject, site and visit each paths
bvec_df <- bvec_df %>% 
  mutate(subject = str_extract(bvec_path, "(?<=sub-)\\d{5}"),
         site = str_extract(bvec_path, "(?<=sub-\\d{5})\\D+"),
         visit = str_extract(bvec_path, "\\d+(?=_acq)"), 
         direction = str_extract(bvec_path, "AX|XPhase"),
         bval = map(bval_path, read_matrix),
         bvec = map(bvec_path, read_matrix),
         .before = bvec_path)

# How many unique values
bvec_df %>% 
  summarize(n_unique_bval = n_distinct(bval),
            n_unique_bvec = n_distinct(bvec))
```

For each site, the number of distinct bval and bvec matrices varies.
```{r}
bvec_df %>% 
  group_by(site) %>% 
  distinct(bval) %>% 
  DT::datatable()
```

```{r}
bvec_df %>% 
  group_by(site) %>% 
  distinct(bvec) %>% 
  DT::datatable()
```


```{r}
bvec_df %>% 
  group_by(site) %>% 
  summarize(n_unique_bval = n_distinct(bval),
            n_unique_bvec = n_distinct(bvec))
```


## Distincts bvals

At Penn, looks like the bval values got paired incorrectly. 

```{r}
# let's look at Penn since David checked those
bvec_df %>% 
  filter(site == 'Penn') %>% 
  group_by(visit, direction) %>% 
  distinct(bval) %>% 
  DT::datatable()
```

But they are highly correlated:

```{r}
# let's look at Penn since David checked those
bvec_df %>% 
  filter(site == 'Penn') %>% 
  distinct(bval) %>% 
  pull(bval) %>% 
  (function(x) cor(c(x[[1]]), c(x[[2]])))
```

At Hopkins, the values appear shifted.

```{r}
bvec_df %>% 
  filter(site == 'Hopkins') %>% 
  distinct(bval) %>% 
  DT::datatable()
```

The correlations is not near 1.

```{r}
bvec_df %>% 
  filter(site == 'Hopkins') %>% 
  distinct(bval) %>% 
  pull(bval) %>% 
  (function(x) cor(c(x[[1]]),
                   c(x[[2]])))
```

At NIH, there are many different bval matrices. But they are all highly correlated (good news).

```{r}
bvec_df %>% 
  filter(site == 'NIH') %>% 
  distinct(bval) %>% 
  pull(bval) %>% 
  combn(m = 2) %>% 
  apply(2, function(x) cor(c(x[[1]]), 
                           c(x[[2]])))

```

The same is true for BWH.  

```{r}
bvec_df %>% 
  filter(site == 'BWH') %>% 
  distinct(bval) %>% 
  pull(bval) %>% 
  combn(m = 2) %>% 
  apply(2, function(x) cor(c(x[[1]]), 
                           c(x[[2]])))
```


## Bvec check

```{r}
# let's look at Penn since David checked those
bvec_df %>% 
  filter(site == 'Penn') %>% 
  distinct(bvec) %>% 
  pull(bvec) %>% 
  (function(x) cor(c(x[[1]]), c(x[[2]])))
```

At Hopkins, the values appear shifted.

```{r}
bvec_df %>% 
  filter(site == 'Hopkins') %>% 
  distinct(bvec) %>% 
  DT::datatable()
```

The correlations is not near 1.

```{r}
bvec_df %>% 
  filter(site == 'Hopkins') %>% 
  distinct(bvec) %>% 
  pull(bvec) %>% 
  (function(x) cor(c(x[[1]]),
                   c(x[[2]])))
```

At NIH, there are many different bvec matrices. But they are all highly correlated (good news).

```{r}
bvec_df %>% 
  filter(site == 'NIH') %>% 
  distinct(bvec) %>% 
  pull(bvec) %>% 
  combn(m = 2) %>% 
  apply(2, function(x) cor(c(x[[1]]), 
                           c(x[[2]])))

```

The same is true for BWH.  

```{r}
bvec_df %>% 
  filter(site == 'BWH') %>% 
  distinct(bvec) %>% 
  pull(bvec) %>% 
  combn(m = 2) %>% 
  apply(2, function(x) cor(c(x[[1]]), 
                           c(x[[2]])))
```

QSIPREP was run after adjusting the bvals across site to match. 

